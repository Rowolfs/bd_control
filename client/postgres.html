<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/index.css">
  <title>PostgreSQL Editor</title>
</head>
<body class="main-body">
  <div class="container mt-4">
    <h3>PostgreSQL Editor</h3>
    <p>База: <span id="dbName"></span></p>

    <!-- Создание новой таблицы -->
    <div class="card mb-4">
      <div class="card-header">Создать новую таблицу</div>
      <div class="card-body">
        <div class="form-row align-items-end">
          <div class="col"><input id="newTableName" class="form-control" placeholder="Имя таблицы"></div>
          <div class="col-auto"><button id="createTable" class="btn btn-info">Создать</button></div>
        </div>
      </div>
    </div>

    <!-- Выбор и загрузка таблицы -->
    <div class="form-row mb-3">
      <div class="col-4"><input id="tableSelect" class="form-control" placeholder="Имя таблицы"></div>
      <div class="col-auto"><button id="loadTable" class="btn btn-primary">Загрузить таблицу</button></div>
    </div>

    <!-- Табличный редактор -->
    <div id="tableEditor" class="table-responsive" style="display:none;">
      <table id="dataTable" class="table table-bordered table-hover">
        <thead><tr id="headerRow"></tr></thead>
        <tbody id="bodyRows"></tbody>
      </table>
      <button id="addRow" class="btn btn-success">Добавить строку</button>
      <button id="saveChanges" class="btn btn-primary ml-2">Сохранить изменения</button>

      <!-- Управление колонками -->
      <div class="mt-4">
        <h5>Управление колонками</h5>
        <div class="form-row align-items-center">
          <div class="col-3"><input id="newColumnName" class="form-control" placeholder="Имя колонки"></div>
          <div class="col-3">
            <select id="newColumnType" class="form-control">
              <option value="text">text</option>
              <option value="integer">integer</option>
              <option value="boolean">boolean</option>
              <option value="date">date</option>
              <option value="timestamp">timestamp</option>
              <option value="varchar(255)">varchar(255)</option>
            </select>
          </div>
          <div class="col-auto"><button id="addColumn" class="btn btn-info">Добавить колонку</button></div>
        </div>
        <div class="form-row align-items-center mt-2">
          <div class="col-4">
            <select id="deleteColumnSelect" class="form-control"></select>
          </div>
          <div class="col-auto"><button id="deleteColumn" class="btn btn-danger">Удалить колонку</button></div>
        </div>
      </div>
    </div>

  </div>
  <script>
    const params = new URLSearchParams(window.location.search);
    const db = params.get('db');
    document.getElementById('dbName').textContent = db;
    let originalData = [];
    let currentTable = '';
    let headers = [];

    // Создать таблицу
    document.getElementById('createTable').onclick = async () => {
      const table = document.getElementById('newTableName').value.trim();
      if (!table) return alert('Введите имя таблицы');
      const res = await fetch(`/api/postgres/${db}`, { method: 'POST' });
      const json = await res.json();
      alert(json.message || json.status);
    };

    // Загрузить данные таблицы
    document.getElementById('loadTable').onclick = async () => {
      const tbl = document.getElementById('tableSelect').value.trim();
      if (!tbl) return alert('Введите имя таблицы');
      const res = await fetch(`/api/postgres/${db}/${tbl}`);
      const json = await res.json();
      if (json.status === 'error') return alert(json.message);
      headers = json.headers;
      originalData = json.data;
      currentTable = tbl;
      renderTable(headers, originalData);
      updateColumnSelector();
    };

    // Рендер таблицы (используем headers даже если data пуст)
    function renderTable(cols, data) {
      document.getElementById('tableEditor').style.display = 'block';
      const hdr = document.getElementById('headerRow'); hdr.innerHTML = '';
      cols.forEach(c => hdr.insertAdjacentHTML('beforeend', `<th>${c}</th>`));
      const body = document.getElementById('bodyRows'); body.innerHTML = '';
      data.forEach((row, idx) => {
        const tr = document.createElement('tr');
        tr.dataset.index = idx;
        cols.forEach(c => tr.insertAdjacentHTML('beforeend', `<td contenteditable>${row[c] || ''}</td>`));
        body.append(tr);
      });
    }

    // Обновить список колонок для удаления
    function updateColumnSelector() {
      const select = document.getElementById('deleteColumnSelect');
      select.innerHTML = '';
      headers.filter(c => c !== 'id').forEach(c => {
        select.insertAdjacentHTML('beforeend', `<option value="${c}">${c}</option>`);
      });
    }

    // Добавить пустую строку
    document.getElementById('addRow').onclick = () => {
      const tr = document.createElement('tr');
      tr.dataset.new = 'true';
      headers.forEach(() => tr.insertAdjacentHTML('beforeend', '<td contenteditable></td>'));
      document.getElementById('bodyRows').append(tr);
    };

    // Сохранить изменения строк
    document.getElementById('saveChanges').onclick = async () => {
      const rows = [];
      document.querySelectorAll('#bodyRows tr').forEach(tr => {
        const cells = [...tr.children].map(td => td.textContent);
        let changed = tr.dataset.new === 'true';
        if (!changed && tr.dataset.index != null) {
          const orig = originalData[Number(tr.dataset.index)];
          for (let i = 0; i < cells.length; i++) {
            if (String(orig[headers[i]] || '') !== cells[i]) { changed = true; break; }
          }
        }
        if (changed) rows.push(cells);
      });
      if (!rows.length) return alert('Нет изменений для сохранения');
      const payload = { keys: headers, values: rows };
      const res = await fetch(`/api/postgres/${db}/${currentTable}/rows`, {
        method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
      });
      const json = await res.json();
      alert(json.message || json.status);
    };

    // Добавить колонку
    document.getElementById('addColumn').onclick = async () => {
      const name = document.getElementById('newColumnName').value.trim();
      const type = document.getElementById('newColumnType').value;
      if (!name) return alert('Введите имя колонки');
      const res = await fetch(`/api/postgres/${db}/${currentTable}/column`, {
        method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ columnName: name, columnType: type })
      });
      const json = await res.json();
      alert(json.message || json.status);
      if (json.status === 'success') document.getElementById('loadTable').click();
    };

    // Удалить колонку
    document.getElementById('deleteColumn').onclick = async () => {
      const name = document.getElementById('deleteColumnSelect').value;
      const res = await fetch(`/api/postgres/${db}/${currentTable}/column`, {
        method: 'DELETE', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ columnName: name })
      });
      const json = await res.json();
      alert(json.message || json.status);
      if (json.status === 'success') document.getElementById('loadTable').click();
    };
  </script>
</body>
</html>
